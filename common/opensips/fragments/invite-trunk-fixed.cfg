# Name: invite-trunk-fixed
# DescriptioN: Static failover

# -----------------------------------------------------------------
# INVITE Message Handler
# -----------------------------------------------------------------

route[invite_trunk_fixed]
{
  xlog("L_DBG","-- route(invite_trunk_fixed)\n");

  $var(original_ru) = $ru;

  # remove any (transport,account,..) params from the RURI
  # ($rP contains current transport protocol)
  $ru = "sip:"+$rU+"@"+$rd+":"+$rp;

  $json(params) := '{}';
  $json(params/source) = $json(src_number/number);
  $json(params/destination) = $rU;
  $json(params/endpoint) = $json(src_endpoint/endpoint);
  $json(params/domain) = $rd;
  $json(params/ruri) = $ru;

  if(rest_post("${services}/route","$json(params)","application/json","$json(route)","application/json")) {

    # The response from the service is a hash with at least `gateways` as an array.
    $var(i) = 0;
    while( $json(gateway) = $json(route/gateways[$var(i)]) ) {

      $branch(q) = $var(i); # Keep them ordered when we hit serialize_branch()

      # Force send through
      if internal_ip
        $branch(socket) = "${internal_ip}"; # force_send_socket(${internal_ip});
      end if internal_ip

      # This is equivalent to the `uri` resolution in tough-rate/middleware/call-handle.coffee.md#L204
      if( $json(gateway/uri) ) {
        $branch(uri) = $json(gateway/uri);
      } else {
        $branch(uri) = "sip:"+$rU+"@"+$json(gateway/address);
      }

      # Note: this will prepend an extra branch we don't need. Is this correct? FIXME
      append_branch();

      # Can't set per-branch attributes.
      if( $json(gateway/attrs/cdr) ) {
        $var(cdr) = $json(gateway/attrs/cdr);
      }
    }

    xlog("L_DBG","-- route(invite_trunk_fixed): routing was successful\n");
    setflag(${flag_trunk_routing});
    t_on_branch("1");
    route(trunk_attributes);
    if mediaproxy
    route(update_media_proxy);  # Start MP if needed
    end if mediaproxy
    route(initial_forwarder);   # Forward
    exit;
  }

  # Restore original RURI in case of failure, and continue.
  $ru = $var(original_ru);
}

route[trunk_attributes]
{
  xlog("L_DBG","-- route(trunk_attributes)\n");
  if($json(dr_rule_attrs/force_mp)) {
    xlog("L_DBG","-- route(trunk_attributes) -- forcing MediaProxy for route\n");
    setflag(${flag_request_mp_callee}); # force MP for callee
  }
  if not skip_uac_auth
    # Per-provider authentication
    xlog("L_DBG","-- route(trunk_attributes) -- gathering authentication\n");
    $avp(uac_realm) = $json(dr_gw_attrs/realm);
    $avp(uac_username) = $json(dr_gw_attrs/username);
    $avp(uac_password) = $json(dr_gw_attrs/password);
  end if not skip_uac_auth

}

branch_route[1]
{
    xlog("L_DBG","-- branch_route(1) Processing $rm $ru\n");
}
